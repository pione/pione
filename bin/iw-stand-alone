#!/usr/bin/env ruby
# -*- ruby -*-

require 'optparse'
require 'innocent-white/common'
require 'innocent-white/agent/input-generator'
require 'innocent-white/agent/task-worker'
require 'innocent-white/agent/rule-provider'
require 'innocent-white/agent/logger'

include InnocentWhite

Thread.abort_on_exception = true

#
# parse options
#

$input_dir = "input"
$output_dir = "output"
$log_path = "log.txt"
$stream = false

option_parser = OptionParser.new do |opt|
  opt.on('-i dir', '--input-dir=dir') {|dir| $input_dir = dir }
  opt.on('-o dir', '--output-dir=dir') {|dir| $output_dir = dir}
  opt.on('-l log', '--log=file') {|path| $log_path = path }
  opt.on('-s', '--stream') { $stream = true }
end
option_parser.parse!(ARGV)

#
# start process
#

# get script dirname
$dir = File.dirname(File.expand_path(__FILE__))

# base uri
uri = "local:#{Dir.mktmpdir('innocent-white-')}/"

# make drb server and it's connection
$tuple_space_server = TupleSpaceServer.new(task_worker_resource: 1, base_uri: uri)
provider = InnocentWhite::TupleSpaceProvider.instance
provider.add($tuple_space_server)

# make logger
Agent[:logger].start($tuple_space_server, File.open($log_path, "w+"))

# read process document
$doc = Document.parse(ARGF.read)

# start rule provider
rule_loader = Agent[:rule_provider].start($tuple_space_server)
rule_loader.read_document($doc)
rule_loader.wait_till(:request_waiting)
$tuple_space_server.write(Tuple[:process_info].new('standalone', 'Standalone'))

# start input generators
generator_method = $stream ? :start_by_stream : :start_by_dir
gen = Agent[:input_generator].send(generator_method, $tuple_space_server, $input_dir)
sleep 0.1 while not(gen.counter > 0)

# add workers
Agent[:task_worker].start($tuple_space_server)

# execute
root = Rule::RootRule.new(RuleExpr.new('Main'))

class CommandExecuter
  def terminate
    begin
      Thread.abort_on_exception = false
      puts ">>> system terminate"
      $tuple_space_server.terminate
      $thread.terminate
    rescue Object => e
      # do nothing
    end
  end
end

Agent[:command_listener].start($tuple_space_server, CommandExecuter.new)

$thread = Thread.start do
  InnocentWhite.debug_mode do
    while true do
      handler = root.make_handler($tuple_space_server)
      outputs = handler.execute
      Dir.mkdir($output_dir) unless File.exist?($output_dir)
      outputs.first.each do |output|
        path = File.join($output_dir, output.name)
        File.open(path, "w+"){|out| out.write(Resource[output.uri].read)}
      end
      sleep 5
      break unless $stream
    end
  end
end
$thread.join
