#!/usr/bin/env ruby
# -*- ruby -*-

require 'pp'
require 'optparse'

require 'pione'
# require 'pione/tuple-space-provider'

include Pione

#
# parse options
#

OPTS = {}
OPTS[:targets] = []
OPTS[:exclusions] = []

option_parser = OptionParser.new do |opt|
  opt.on('-t', '--target=name') {|name| OPTS[:targets] << name }
  opt.on('-e', '--exclude=name') {|name| OPTS[:exclusions] << name}
  opt.on('--color=true or false') {|str|
    bool = nil
    bool = true if str == "true"
    bool = false if str == "false"
    if bool.nil?
      puts "invalid color option: %s" % bool
      exit
    end
    Terminal.color_mode = bool
  }
end

begin
  option_parser.parse!(ARGV)
rescue OptionParser::InvalidOption => e
  e.args.each {|arg| puts "unknown option: #{arg}" }
  exit
end

#
# start druby environment
#

DRb.start_service

# tuple space provider
provider = TupleSpaceProvider.instance

# tuple space servers are not found
if provider.tuple_space_servers.empty?
  puts "No tuple space servers."
  exit 0
end

def show_bag(ts_server, type)
  ts_server.all_tuples(type).each do |tuple|
    # target option
    if not(OPTS[:targets].empty?) and not(OPTS[:targets].include?(tuple.first.to_s))
      next
    end

    # exclude option
    if OPTS[:exclusions].include?(tuple.first.to_s)
      next
    end

    res = PP.pp(tuple, "")
    res.gsub!(/\:[a-z]\w+/) {|s| Terminal.red(s) }
    res.gsub!(/\#<(\S+)/) {|s| "#<%s" % Terminal.green($1) }
    puts res
  end
end

# print tuples
provider.tuple_space_servers.each do |ts_server|
  puts "TupleSpaceServer: %s" % Terminal.red(ts_server.uuid)
  puts "-"*78
  puts "*** bag ***"
  show_bag(ts_server, :bag)
  puts "*** read waiter ***"
  show_bag(ts_server, :read_waiter)
  puts "*** take waiter ***"
  show_bag(ts_server, :take_waiter)
end
