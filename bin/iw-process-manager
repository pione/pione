#!/usr/bin/env ruby
# -*- ruby -*-

require 'pione'
require 'pione/tuple-space-provider'
require 'pione/simulator/input-generator'
require 'pione/agent/logger'
require 'pione/agent/process-manager'
require 'pione/process-handler'
require 'pione/document'

Thread.abort_on_exception = true

Pione.debug_mode
Pione.set_signal_trap
DRb.start_service

# tuple space provider
provider = Pione::TupleSpaceProvider.get

# server
server = Pione::TupleSpaceServer.new(task_worker_resource: 2)

# register tuple space server
provider.add(server)

# logger
Pione::Agent[:logger].new(server)

# input generator
generator = Pione::Simulator::SimpleInputGeneratorMethod.new("test-001".."test-100", "a", 1..100)
Pione::Agent[:input_generator].new(server, generator)

# process definition document
if ARGF.filename == "-"
  puts "No process document."
  exit
end
doc = Pione::Document.load(ARGF)

# process manager
Pione::Agent[:process_manager].new(server, doc)

DRb.thread.join
